<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Seller Service</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <div class="dashboard">
        <nav class="navbar">
            <div class="container">
                <a href="/admin.html" class="navbar-brand">ğŸª Seller Service - Admin</a>
                <div class="navbar-nav">
                    <a href="#" id="categoryLink" class="btn btn-success btn-sm">ğŸ“‚ Kategori YÃ¶netimi</a>
                    <span class="badge badge-admin">ADMIN</span>
                    <a href="#" id="authLink" class="btn btn-secondary btn-sm">Auth Service</a>
                </div>
            </div>
        </nav>

        <div class="dashboard-content">
            <div class="container">
                <div class="dashboard-header">
                    <h1>ğŸ“‹ SatÄ±cÄ± BaÅŸvurularÄ±</h1>
                    <p>SatÄ±cÄ± baÅŸvurularÄ±nÄ± inceleyin ve onaylayÄ±n</p>
                </div>

                <!-- Filter Tabs -->
                <div class="card" style="padding: 12px 16px; margin-bottom: 24px;">
                    <div class="filter-tabs">
                        <button class="btn btn-sm" style="background: var(--primary); color: white;"
                            data-status="PENDING" onclick="filterApplications('PENDING', this)">
                            â³ Bekleyen
                        </button>
                        <button class="btn btn-secondary btn-sm" data-status="APPROVED"
                            onclick="filterApplications('APPROVED', this)">
                            âœ… Onaylanan
                        </button>
                        <button class="btn btn-secondary btn-sm" data-status="REJECTED"
                            onclick="filterApplications('REJECTED', this)">
                            âŒ Reddedilen
                        </button>
                        <button class="btn btn-secondary btn-sm" data-status="ALL"
                            onclick="filterApplications('ALL', this)">
                            ğŸ“‹ TÃ¼mÃ¼
                        </button>
                    </div>
                </div>

                <!-- Applications Table -->
                <div class="card">
                    <div class="card-header">
                        <h2>BaÅŸvuru Listesi</h2>
                        <span id="applicationCount" class="badge badge-pending">0 baÅŸvuru</span>
                    </div>

                    <div id="loadingMessage" class="alert alert-info">
                        <span>â³</span><span>YÃ¼kleniyor...</span>
                    </div>

                    <div id="emptyMessage" class="alert alert-info hidden">
                        <span>ğŸ“­</span><span>Bu kategoride baÅŸvuru yok.</span>
                    </div>

                    <div class="table-container">
                        <table id="applicationsTable" class="hidden">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>KullanÄ±cÄ±</th>
                                    <th>MaÄŸaza</th>
                                    <th>Vergi No</th>
                                    <th>Durum</th>
                                    <th>Tarih</th>
                                    <th>Ä°ÅŸlemler</th>
                                </tr>
                            </thead>
                            <tbody id="applicationsBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reject Modal -->
    <div id="rejectModal" class="modal hidden">
        <div class="auth-card" style="max-width: 400px;">
            <h2 style="margin-bottom: 16px;">BaÅŸvuruyu Reddet</h2>
            <div class="form-group">
                <label>Red Sebebi</label>
                <input type="text" id="rejectReason" class="form-control" placeholder="Sebebi yazÄ±n">
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-danger" onclick="confirmReject()">Reddet</button>
                <button class="btn btn-secondary" onclick="closeRejectModal()">Ä°ptal</button>
            </div>
        </div>
    </div>

    <script>
        let currentStatus = 'PENDING';
        let rejectingAppId = null;
        let authServiceUrl = 'http://localhost:3001';
        let categoryServiceUrl = 'http://localhost:3002';

        async function init() {
            try {
                const res = await fetch('/api/config');
                const config = await res.json();
                authServiceUrl = config.authServiceUrl;
                categoryServiceUrl = config.categoryServiceUrl || 'http://localhost:3002';
            } catch { }

            document.getElementById('authLink').href = authServiceUrl;
            document.getElementById('categoryLink').href = categoryServiceUrl;
            loadApplications();
        }

        async function loadApplications() {
            const loading = document.getElementById('loadingMessage');
            const empty = document.getElementById('emptyMessage');
            const table = document.getElementById('applicationsTable');
            const tbody = document.getElementById('applicationsBody');
            const count = document.getElementById('applicationCount');

            loading.classList.remove('hidden');
            empty.classList.add('hidden');
            table.classList.add('hidden');

            try {
                const res = await fetch(`/api/admin/applications?status=${currentStatus}`);
                const data = await res.json();

                loading.classList.add('hidden');

                if (!data.applications || data.applications.length === 0) {
                    empty.classList.remove('hidden');
                    count.textContent = '0 baÅŸvuru';
                    return;
                }

                count.textContent = `${data.applications.length} baÅŸvuru`;

                tbody.innerHTML = data.applications.map(app => `
                    <tr>
                        <td>#${app.id}</td>
                        <td>
                            <strong>${app.userName}</strong><br>
                            <small style="color: var(--text-muted);">${app.userEmail}</small>
                        </td>
                        <td>${app.storeName}</td>
                        <td>${app.taxNumber}</td>
                        <td>
                            <span class="badge badge-${app.status.toLowerCase()}">${app.status === 'PENDING' ? 'Beklemede' :
                        app.status === 'APPROVED' ? 'OnaylandÄ±' : 'Reddedildi'
                    }</span>
                            ${app.rejectionReason ? `<br><small style="color: var(--text-muted);">${app.rejectionReason}</small>` : ''}
                        </td>
                        <td>${new Date(app.createdAt).toLocaleDateString('tr-TR')}</td>
                        <td>
                            ${app.status === 'PENDING' ? `
                                <div class="actions">
                                    <button class="btn btn-success btn-sm" onclick="approveApp(${app.id})">âœ“ Onayla</button>
                                    <button class="btn btn-danger btn-sm" onclick="openRejectModal(${app.id})">âœ— Reddet</button>
                                </div>
                            ` : '-'}
                        </td>
                    </tr>
                `).join('');

                table.classList.remove('hidden');
            } catch (error) {
                loading.classList.add('hidden');
                empty.innerHTML = '<span>âš ï¸</span><span>YÃ¼kleme hatasÄ±</span>';
                empty.className = 'alert alert-error';
                empty.classList.remove('hidden');
            }
        }

        function filterApplications(status, btn) {
            currentStatus = status;
            document.querySelectorAll('.filter-tabs button').forEach(b => {
                b.className = 'btn btn-secondary btn-sm';
            });
            btn.className = 'btn btn-sm';
            btn.style.background = 'var(--primary)';
            btn.style.color = 'white';
            loadApplications();
        }

        async function approveApp(id) {
            if (!confirm('BaÅŸvuruyu onaylamak istediÄŸinize emin misiniz?\nKullanÄ±cÄ±ya SELLER rolÃ¼ eklenecek.')) return;

            try {
                const res = await fetch(`/api/admin/applications/${id}/approve`, { method: 'PUT' });
                const data = await res.json();

                if (res.ok) {
                    alert('BaÅŸvuru onaylandÄ±! SELLER rolÃ¼ Auth Service\'e gÃ¶nderildi.');
                    loadApplications();
                } else {
                    alert(data.error || 'Hata oluÅŸtu');
                }
            } catch {
                alert('BaÄŸlantÄ± hatasÄ±');
            }
        }

        function openRejectModal(id) {
            rejectingAppId = id;
            document.getElementById('rejectReason').value = '';
            document.getElementById('rejectModal').classList.remove('hidden');
        }

        function closeRejectModal() {
            rejectingAppId = null;
            document.getElementById('rejectModal').classList.add('hidden');
        }

        async function confirmReject() {
            const reason = document.getElementById('rejectReason').value;

            try {
                const res = await fetch(`/api/admin/applications/${rejectingAppId}/reject`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });

                if (res.ok) {
                    alert('BaÅŸvuru reddedildi');
                    closeRejectModal();
                    loadApplications();
                } else {
                    const data = await res.json();
                    alert(data.error || 'Hata');
                }
            } catch {
                alert('BaÄŸlantÄ± hatasÄ±');
            }
        }

        init();
    </script>
</body>

</html>