<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kategori Y√∂netimi - Category Service</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <div class="dashboard">
        <nav class="navbar">
            <div class="container">
                <a href="/" class="navbar-brand">üìÇ Category Service</a>
                <div>
                    <span class="badge badge-count" id="statsCount">Y√ºkleniyor...</span>
                </div>
            </div>
        </nav>

        <div class="dashboard-content">
            <div class="container">
                <div class="dashboard-header">
                    <h1>üìÇ Kategori Y√∂netimi</h1>
                    <p>Kategori, √ºr√ºn t√ºr√º ve marka ekleyin</p>
                </div>

                <div class="grid-3">
                    <!-- Add Category Form -->
                    <div class="card">
                        <div class="card-header">
                            <h2>‚ûï Kategori Ekle</h2>
                        </div>
                        <div id="categoryAlert" class="alert hidden"></div>
                        <form id="categoryForm">
                            <div class="form-group">
                                <label>Kategori Adƒ± *</label>
                                <input type="text" id="categoryName" class="form-control" placeholder="√ñrn: Elektronik"
                                    required>
                            </div>
                            <div class="form-group">
                                <label>A√ßƒ±klama</label>
                                <input type="text" id="categoryDesc" class="form-control" placeholder="Kƒ±sa a√ßƒ±klama">
                            </div>
                            <div class="form-group">
                                <label>ƒ∞kon (Emoji)</label>
                                <input type="text" id="categoryIcon" class="form-control" placeholder="üì±">
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">Kategori Ekle</button>
                        </form>
                    </div>

                    <!-- Add Product Type Form -->
                    <div class="card">
                        <div class="card-header">
                            <h2>‚ûï √úr√ºn T√ºr√º Ekle</h2>
                        </div>
                        <div id="typeAlert" class="alert hidden"></div>
                        <form id="typeForm">
                            <div class="form-group">
                                <label>Kategori Se√ß *</label>
                                <select id="typeCategoryId" class="form-control" required>
                                    <option value="">Kategori se√ßin</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>√úr√ºn T√ºr√º Adƒ± *</label>
                                <input type="text" id="typeName" class="form-control" placeholder="√ñrn: Telefon"
                                    required>
                            </div>
                            <div class="form-group">
                                <label>A√ßƒ±klama</label>
                                <input type="text" id="typeDesc" class="form-control" placeholder="Kƒ±sa a√ßƒ±klama">
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">√úr√ºn T√ºr√º Ekle</button>
                        </form>
                    </div>

                    <!-- Add Brand Form -->
                    <div class="card">
                        <div class="card-header">
                            <h2>‚ûï Marka Ekle</h2>
                        </div>
                        <div id="brandAlert" class="alert hidden"></div>
                        <form id="brandForm">
                            <div class="form-group">
                                <label>Kategori Se√ß</label>
                                <select id="brandCategoryId" class="form-control">
                                    <option value="">√ñnce kategori se√ßin</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>√úr√ºn T√ºr√º Se√ß *</label>
                                <select id="brandTypeId" class="form-control" required disabled>
                                    <option value="">√úr√ºn t√ºr√º se√ßin</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Marka Adƒ± *</label>
                                <input type="text" id="brandName" class="form-control" placeholder="√ñrn: Samsung"
                                    required>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">Marka Ekle</button>
                        </form>
                    </div>
                </div>

                <!-- Category Tree View -->
                <div class="card">
                    <div class="card-header">
                        <h2>üå≥ Kategori Yapƒ±sƒ±</h2>
                        <button class="btn btn-secondary btn-sm" onclick="loadCategories()">üîÑ Yenile</button>
                    </div>
                    <ul class="category-tree" id="categoryTree">
                        <li style="text-align: center; padding: 40px; color: var(--text-muted);">Y√ºkleniyor...</li>
                    </ul>
                </div>

                <!-- JSON Preview -->
                <div class="card">
                    <div class="card-header">
                        <h2>üìã API Response (JSON)</h2>
                        <code style="color: var(--text-muted);">GET /api/categories</code>
                    </div>
                    <pre class="json-preview" id="jsonPreview">Y√ºkleniyor...</pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allData = { categories: [], productTypes: [], brands: [] };

        async function loadCategories() {
            try {
                // Load nested data
                const res = await fetch('/api/categories');
                const data = await res.json();

                if (data.success) {
                    renderCategoryTree(data.data);
                    document.getElementById('jsonPreview').textContent = JSON.stringify(data, null, 2);
                }

                // Load flat data for dropdowns
                const flatRes = await fetch('/api/categories/flat');
                const flatData = await flatRes.json();

                if (flatData.success) {
                    allData = flatData.data;
                    updateDropdowns();
                    updateStats();
                }
            } catch (error) {
                console.error('Load error:', error);
            }
        }

        function renderCategoryTree(categories) {
            const tree = document.getElementById('categoryTree');

            if (categories.length === 0) {
                tree.innerHTML = '<li style="text-align: center; padding: 40px; color: var(--text-muted);">Hen√ºz kategori yok. Yukarƒ±dan ekleyin.</li>';
                return;
            }

            tree.innerHTML = categories.map(cat => `
                <li class="category-item">
                    <div class="category-header">
                        <div class="category-name">
                            <span class="category-icon">${cat.icon || 'üìÅ'}</span>
                            <span>${cat.name}</span>
                            <span class="badge badge-count">${cat.types.length} t√ºr</span>
                        </div>
                        <div class="actions">
                            <button class="btn btn-secondary btn-sm" onclick="editCategory(${cat.id}, '${cat.name}', '${cat.description || ''}', '${cat.icon || ''}')">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteCategory(${cat.id})">üóë</button>
                        </div>
                    </div>
                    ${cat.types.length > 0 ? `
                        <ul class="type-list">
                            ${cat.types.map(type => `
                                <li class="type-item">
                                    <div class="type-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div class="type-name" style="margin-bottom: 0;">
                                            ${type.name}
                                            <span class="badge badge-count">${type.brands.length} marka</span>
                                        </div>
                                        <div class="actions">
                                            <button class="btn btn-secondary btn-sm" onclick="editType(${type.id}, '${type.name}')">‚úèÔ∏è</button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteType(${type.id})">üóë</button>
                                        </div>
                                    </div>
                                    <div class="brand-list">
                                        ${type.brands.map(brand => `
                                            <span class="brand-tag" style="cursor: pointer;" onclick="showBrandActions(${brand.id}, '${brand.name}')">
                                                ${brand.name} √ó
                                            </span>
                                        `).join('')}
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    ` : ''}
                </li>
            `).join('');
        }

        function updateDropdowns() {
            // Category dropdowns
            const categoryOptions = '<option value="">Kategori se√ßin</option>' +
                allData.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

            document.getElementById('typeCategoryId').innerHTML = categoryOptions;
            document.getElementById('brandCategoryId').innerHTML = categoryOptions;
        }

        function updateStats() {
            const stats = `${allData.categories.length} Kategori | ${allData.productTypes.length} T√ºr | ${allData.brands.length} Marka`;
            document.getElementById('statsCount').textContent = stats;
        }

        // Category form
        document.getElementById('categoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const alert = document.getElementById('categoryAlert');

            try {
                const res = await fetch('/api/categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: document.getElementById('categoryName').value,
                        description: document.getElementById('categoryDesc').value,
                        icon: document.getElementById('categoryIcon').value
                    })
                });
                const data = await res.json();

                alert.className = `alert alert-${res.ok ? 'success' : 'error'}`;
                alert.innerHTML = `<span>${res.ok ? '‚úÖ' : '‚ö†Ô∏è'}</span><span>${data.message || data.error}</span>`;
                alert.classList.remove('hidden');

                if (res.ok) {
                    e.target.reset();
                    loadCategories();
                }
            } catch (error) {
                alert.className = 'alert alert-error';
                alert.innerHTML = '<span>‚ö†Ô∏è</span><span>Baƒülantƒ± hatasƒ±</span>';
                alert.classList.remove('hidden');
            }
        });

        // Type form
        document.getElementById('typeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const alert = document.getElementById('typeAlert');
            const categoryId = document.getElementById('typeCategoryId').value;

            try {
                const res = await fetch(`/api/categories/${categoryId}/types`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: document.getElementById('typeName').value,
                        description: document.getElementById('typeDesc').value
                    })
                });
                const data = await res.json();

                alert.className = `alert alert-${res.ok ? 'success' : 'error'}`;
                alert.innerHTML = `<span>${res.ok ? '‚úÖ' : '‚ö†Ô∏è'}</span><span>${data.message || data.error}</span>`;
                alert.classList.remove('hidden');

                if (res.ok) {
                    document.getElementById('typeName').value = '';
                    document.getElementById('typeDesc').value = '';
                    loadCategories();
                }
            } catch (error) {
                alert.className = 'alert alert-error';
                alert.innerHTML = '<span>‚ö†Ô∏è</span><span>Baƒülantƒ± hatasƒ±</span>';
                alert.classList.remove('hidden');
            }
        });

        // Brand category change - load types
        document.getElementById('brandCategoryId').addEventListener('change', function () {
            const categoryId = this.value;
            const typeSelect = document.getElementById('brandTypeId');

            if (!categoryId) {
                typeSelect.innerHTML = '<option value="">√úr√ºn t√ºr√º se√ßin</option>';
                typeSelect.disabled = true;
                return;
            }

            const types = allData.productTypes.filter(t => t.categoryId == categoryId);
            typeSelect.innerHTML = '<option value="">√úr√ºn t√ºr√º se√ßin</option>' +
                types.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            typeSelect.disabled = false;
        });

        // Brand form
        document.getElementById('brandForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const alert = document.getElementById('brandAlert');
            const typeId = document.getElementById('brandTypeId').value;

            try {
                const res = await fetch(`/api/categories/types/${typeId}/brands`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: document.getElementById('brandName').value
                    })
                });
                const data = await res.json();

                alert.className = `alert alert-${res.ok ? 'success' : 'error'}`;
                alert.innerHTML = `<span>${res.ok ? '‚úÖ' : '‚ö†Ô∏è'}</span><span>${data.message || data.error}</span>`;
                alert.classList.remove('hidden');

                if (res.ok) {
                    document.getElementById('brandName').value = '';
                    loadCategories();
                }
            } catch (error) {
                alert.className = 'alert alert-error';
                alert.innerHTML = '<span>‚ö†Ô∏è</span><span>Baƒülantƒ± hatasƒ±</span>';
                alert.classList.remove('hidden');
            }
        });

        // DELETE FUNCTIONS
        async function deleteCategory(id) {
            if (!confirm('Bu kategoriyi silmek istediƒüinize emin misiniz?\nAlt t√ºrler ve markalar da silinecek.')) return;
            try {
                await fetch(`/api/categories/${id}`, { method: 'DELETE' });
                loadCategories();
            } catch (error) {
                alert('Silme hatasƒ±');
            }
        }

        async function deleteType(id) {
            if (!confirm('Bu √ºr√ºn t√ºr√ºn√º silmek istediƒüinize emin misiniz?\nAlt markalar da silinecek.')) return;
            try {
                await fetch(`/api/categories/types/${id}`, { method: 'DELETE' });
                loadCategories();
            } catch (error) {
                alert('Silme hatasƒ±');
            }
        }

        async function deleteBrand(id) {
            try {
                await fetch(`/api/categories/brands/${id}`, { method: 'DELETE' });
                loadCategories();
            } catch (error) {
                alert('Silme hatasƒ±');
            }
        }

        function showBrandActions(id, name) {
            const action = confirm(`"${name}" markasƒ±nƒ± silmek istiyor musunuz?`);
            if (action) {
                deleteBrand(id);
            }
        }

        // EDIT FUNCTIONS
        async function editCategory(id, name, description, icon) {
            const newName = prompt('Kategori adƒ±:', name);
            if (newName === null) return;

            const newDesc = prompt('A√ßƒ±klama:', description);
            const newIcon = prompt('ƒ∞kon (emoji):', icon);

            try {
                await fetch(`/api/categories/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: newName || undefined,
                        description: newDesc || undefined,
                        icon: newIcon || undefined
                    })
                });
                loadCategories();
            } catch (error) {
                alert('G√ºncelleme hatasƒ±');
            }
        }

        async function editType(id, name) {
            const newName = prompt('√úr√ºn t√ºr√º adƒ±:', name);
            if (newName === null || newName === '') return;

            try {
                await fetch(`/api/categories/types/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName })
                });
                loadCategories();
            } catch (error) {
                alert('G√ºncelleme hatasƒ±');
            }
        }

        // Init
        loadCategories();
    </script>
</body>

</html>